<!-- <!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Thanh to√°n d∆∞ n·ª£</title>
  <style>
    * {
      padding: 0;
      margin: 0;
      box-sizing: border-box;
    }
    html {
      font-family: Arial, Helvetica, sans-serif;
      overflow: hidden;
    }
    #Reader {
      scroll-behavior: smooth;
      width: calc(100% - 215px);
      height: 95vh;
      position: fixed;
      bottom: 0;
      right: 0;
      overflow-y: auto;
      overflow-x: hidden;
    }
    #ThueSach {
      overflow: hidden;
    }
    .info-box {
      padding: 15px 20px;
      border-bottom: 1px solid #ddd;
      background: #f8f9fa;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    .info-item {
      min-width: 250px;
      font-size: 15px;
    }
    .info-label {
      font-weight: 600;
      color: #495057;
    }
    .pay-summary {
      margin-top: 15px;
      padding: 15px 20px;
      background: #fff3cd;
      border: 2px solid #ffc107;
      font-size: 16px;
      border-radius: 4px;
    }
    .pay-summary span {
      font-weight: 700;
      color: #d9534f;
      font-size: 20px;
    }
    .pay-method {
      margin-top: 20px;
      padding: 15px 20px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .pay-method label {
      font-size: 15px;
      font-weight: 600;
      display: block;
      margin-bottom: 8px;
      color: #495057;
    }
    .pay-method select,
    .pay-method textarea {
      width: 100%;
      max-width: 500px;
      margin-top: 6px;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ced4da;
      border-radius: 4px;
    }
    .pay-method textarea {
      min-height: 100px;
      resize: vertical;
      font-family: Arial, Helvetica, sans-serif;
    }
    .pay-actions {
      margin-top: 20px;
      padding: 15px 20px;
      display: flex;
      gap: 15px;
    }
    .btn-pay {
      background: #28a745;
      color: #fff;
      border: none;
      padding: 12px 30px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .btn-pay:hover {
      background: #218838;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .btn-pay:disabled {
      opacity: .6;
      cursor: not-allowed;
      background: #6c757d;
      transform: none;
    }
    .btn-back {
      border: 1px solid #6c757d;
      background: #6c757d;
      color: #fff;
      padding: 12px 30px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .btn-back:hover {
      background: #5a6268;
      transform: translateY(-1px);
    }
    .box-fil {
      margin-bottom: 20px;
    }
    #fil p {
      font-size: 16px;
      font-weight: 600;
      padding: 15px 20px;
      background: #e9ecef;
      border-left: 4px solid #007bff;
    }
  </style>
  <link rel="stylesheet" href="../css/style_Readermanagement.css" />
</head>
<body>
  <div id="ThueSach">
    <div id="Reader">
      <div id="header">
        <p>Thanh to√°n d∆∞ n·ª£ b·∫°n ƒë·ªçc</p>
      </div>

      <div id="container">
        <!-- Th√¥ng tin b·∫°n ƒë·ªçc -->
        <div class="box-fil">
          <div id="fil">
            <p>Th√¥ng tin b·∫°n ƒë·ªçc</p>
          </div>
          <div class="info-box">
            <div class="info-item">
              <span class="info-label">M√£ b·∫°n ƒë·ªçc:</span> 
              <span id="info-maBD">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">H·ªç t√™n:</span> 
              <span id="info-hoTen">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">Email:</span> 
              <span id="info-email">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">S·ªë ƒëi·ªán tho·∫°i:</span> 
              <span id="info-sdt">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">S·ªë th·∫ª:</span> 
              <span id="info-soThe">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">D∆∞ n·ª£:</span> 
              <span id="info-duNo" style="color: #d9534f; font-weight: 600;">-</span>
            </div>
          </div>
          <div class="pay-summary">
            üí∞ T·ªïng d∆∞ n·ª£ c·∫ßn thanh to√°n: <span id="total-debt">0 ‚Ç´</span>
          </div>
        </div>

        <!-- Thi·∫øt l·∫≠p thanh to√°n -->
        <div class="box-fil">
          <div id="fil">
            <p>Thi·∫øt l·∫≠p thanh to√°n</p>
          </div>

          <div class="pay-method">
            <label for="pay-method">H√¨nh th·ª©c thanh to√°n <span style="color: red;">*</span></label>
            <select id="pay-method">
              <option value="Ti·ªÅn m·∫∑t">Ti·ªÅn m·∫∑t</option>
              <option value="Th·∫ª">Th·∫ª</option>
              <option value="Chuy·ªÉn kho·∫£n">Chuy·ªÉn kho·∫£n</option>
              <option value="V√≠ ƒëi·ªán t·ª≠">V√≠ ƒëi·ªán t·ª≠</option>
            </select>

            <label for="pay-note" style="margin-top: 20px;">Ghi ch√∫ (t√πy ch·ªçn)</label>
            <textarea id="pay-note" placeholder="Nh·∫≠p ghi ch√∫ n·∫øu c·∫ßn..."></textarea>
          </div>

          <div class="pay-actions">
            <button class="btn-back" type="button" id="btnBack">‚Üê Quay l·∫°i</button>
            <button class="btn-pay" type="button" id="btnPay">üí∞ Thanh to√°n ngay</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS x·ª≠ l√Ω thanh to√°n -->
  <script>
    const PAY_BANDOC_KEY = 'PAY_BANDOC';
    const API_THANHTOAN = 'https://localhost:7151/api/thanhtoan/phat';
    const API_PHAT = 'https://localhost:7151/api/phat';

    let currentReader = null;
    let cacKhoanPhat = [];

    // ========== KH·ªûI T·∫†O ==========
    (function init() {
      console.log('üöÄ Kh·ªüi t·∫°o trang thanh to√°n');
      
      const raw = sessionStorage.getItem(PAY_BANDOC_KEY);
      if (!raw) {
        alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin b·∫°n ƒë·ªçc. Vui l√≤ng ch·ªçn l·∫°i.');
        goBack();
        return;
      }

      try {
        currentReader = JSON.parse(raw);
        console.log('‚úÖ D·ªØ li·ªáu b·∫°n ƒë·ªçc:', currentReader);
      } catch (err) {
        console.error('‚ùå L·ªói parse:', err);
        alert('D·ªØ li·ªáu b·ªã l·ªói.');
        goBack();
        return;
      }

      fillReaderInfo(currentReader);
      attachButtons();
      loadUnpaidFines(currentReader.maBanDoc);
    })();

    // ========== HI·ªÇN TH·ªä TH√îNG TIN ==========
    function fillReaderInfo(bd) {
      document.getElementById('info-maBD').textContent = bd.maBanDoc || '-';
      document.getElementById('info-hoTen').textContent = bd.hoTen || '-';
      document.getElementById('info-email').textContent = bd.email || '-';
      document.getElementById('info-sdt').textContent = bd.dienThoai || '-';
      document.getElementById('info-soThe').textContent = bd.soThe || '-';
      
      const duNo = Number(bd.duNo || 0);
      document.getElementById('info-duNo').textContent = formatMoney(duNo) + ' ‚Ç´';
      document.getElementById('total-debt').textContent = formatMoney(duNo) + ' ‚Ç´';

      const btnPay = document.getElementById('btnPay');
      if (duNo <= 0) {
        btnPay.disabled = true;
        btnPay.textContent = '‚úÖ Kh√¥ng c√≥ d∆∞ n·ª£';
      }
    }

    // ========== G·∫ÆN S·ª∞ KI·ªÜN ==========
    function attachButtons() {
      document.getElementById('btnBack').onclick = goBack;
      document.getElementById('btnPay').onclick = handlePayment;
    }

    function goBack() {
      if (typeof loadPage === 'function') {
        loadPage('../html/Readermanagement.html', 'initReaderPage');
      } else {
        window.history.back();
      }
    }

    // ========== LOAD PH·∫†T (·∫®N, CH·ªà ƒê·ªÇ L·∫§Y DANH S√ÅCH) ==========
    async function loadUnpaidFines(maBanDoc) {
      try {
        const res = await fetch(`${API_PHAT}/chua-thanh-toan/${maBanDoc}`, { cache: 'no-store' });
        
        if (res.ok) {
          let data = await res.json();
          if (data?.data) data = data.data;
          if (Array.isArray(data)) {
            cacKhoanPhat = data;
            console.log(`‚úÖ T√¨m th·∫•y ${cacKhoanPhat.length} kho·∫£n ph·∫°t ch∆∞a thanh to√°n`);
          }
        }
      } catch (err) {
        console.warn('‚ö†Ô∏è Kh√¥ng load ƒë∆∞·ª£c ph·∫°t:', err);
      }
    }

    // ========== X·ª¨ L√ù THANH TO√ÅN ==========
    async function handlePayment() {
      const duNo = Number(currentReader.duNo || 0);
      if (duNo <= 0) {
        alert('B·∫°n ƒë·ªçc kh√¥ng c√≥ d∆∞ n·ª£!');
        return;
      }

      const payMethod = document.getElementById('pay-method').value;
      const note = document.getElementById('pay-note').value;

      const confirmMsg = `X√°c nh·∫≠n thanh to√°n?\n\n` +
                        `üë§ B·∫°n ƒë·ªçc: ${currentReader.hoTen}\n` +
                        `üí∞ S·ªë ti·ªÅn: ${formatMoney(duNo)} ‚Ç´\n` +
                        `üí≥ H√¨nh th·ª©c: ${payMethod}\n` +
                        `üìù Ghi ch√∫: ${note || '(Kh√¥ng c√≥)'}`;

      if (!confirm(confirmMsg)) return;

      const btnPay = document.getElementById('btnPay');
      btnPay.disabled = true;
      btnPay.textContent = '‚è≥ ƒêang x·ª≠ l√Ω...';

      // N·∫øu c√≥ ph·∫°t trong h·ªá th·ªëng, thanh to√°n t·ª´ng ph·∫°t
      if (cacKhoanPhat.length > 0) {
        await payAllFines(payMethod, note);
      } else {
        // N·∫øu kh√¥ng c√≥ ph·∫°t, b√°o l·ªói
        alert('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y kho·∫£n ph·∫°t n√†o ƒë·ªÉ thanh to√°n.\n\nVui l√≤ng ki·ªÉm tra l·∫°i ho·∫∑c li√™n h·ªá qu·∫£n tr·ªã vi√™n.');
        btnPay.disabled = false;
        btnPay.textContent = 'üí∞ Thanh to√°n ngay';
      }
    }

    // ========== THANH TO√ÅN T·∫§T C·∫¢ PH·∫†T ==========
    async function payAllFines(payMethod, note) {
      let thanhCong = 0;
      let thatBai = 0;
      const errors = [];

      for (let i = 0; i < cacKhoanPhat.length; i++) {
        const phat = cacKhoanPhat[i];
        const maPhat = phat.MaPhat || phat.maPhat;
        const maThanhToan = 'TT' + Date.now() + '_' + i;

        const payload = {
          MaPhat: maPhat,
          MaThanhToan: maThanhToan,
          HinhThuc: payMethod,
          GhiChu: note || `Thanh to√°n ph·∫°t ${maPhat}`
        };

        console.log(`üì§ [${i+1}/${cacKhoanPhat.length}] Thanh to√°n ${maPhat}`);

        try {
          const res = await fetch(API_THANHTOAN, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const text = await res.text();
          let result;
          try { result = JSON.parse(text); } catch { result = null; }

          if (res.ok && (!result || result.success !== false)) {
            thanhCong++;
            console.log(`‚úÖ ${maPhat} th√†nh c√¥ng`);
          } else {
            thatBai++;
            const errMsg = result?.message || text || `HTTP ${res.status}`;
            errors.push(`${maPhat}: ${errMsg}`);
            console.error(`‚ùå ${maPhat} th·∫•t b·∫°i:`, errMsg);
          }
        } catch (err) {
          thatBai++;
          errors.push(`${maPhat}: ${err.message}`);
          console.error(`‚ùå ${maPhat} l·ªói:`, err);
        }

        await new Promise(resolve => setTimeout(resolve, 200));
      }

      // Hi·ªÉn th·ªã k·∫øt qu·∫£
      if (thatBai === 0) {
        alert(`‚úÖ Thanh to√°n th√†nh c√¥ng!\n\nüí∞ ƒê√£ thanh to√°n ${thanhCong} kho·∫£n ph·∫°t\nüìù D∆∞ n·ª£ ƒë√£ ƒë∆∞·ª£c x√≥a`);
        location.reload();
      } else {
        let msg = `K·∫øt qu·∫£ thanh to√°n:\n\n‚úÖ Th√†nh c√¥ng: ${thanhCong}\n‚ùå Th·∫•t b·∫°i: ${thatBai}\n`;
        if (errors.length > 0) {
          msg += `\nL·ªói:\n${errors.join('\n')}`;
        }
        alert(msg);
        
        if (thanhCong > 0) {
          location.reload();
        } else {
          const btnPay = document.getElementById('btnPay');
          btnPay.disabled = false;
          btnPay.textContent = 'üí∞ Thanh to√°n ngay';
        }
      }
    }

    // ========== HELPER ==========
    function formatMoney(v) {
      return (Number(v) || 0).toLocaleString('vi-VN');
    }
  </script>
</body>
</html>